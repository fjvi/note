## æ’ä»¶åŠ è½½å™¨å®Œæ•´å®æ–½æ–¹æ¡ˆ

ä¸‹é¢æˆ‘å°†æä¾›å®Œæ•´çš„ä»£ç å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ ¸å¿ƒç³»ç»Ÿã€æ’ä»¶æ¥å£å’Œç°æœ‰åŠŸèƒ½çš„æ’ä»¶åŒ–æ”¹é€ ã€‚

## 1\. æ ¸å¿ƒç³»ç»Ÿå®ç°

åˆ›å»º `plugin-system.js` æ–‡ä»¶ï¼š

```markdown
class EventEmitter {
  constructor() {
    this.listeners = new Map();
  }

  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event).push(callback);
  }

  emit(event, ...args) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback => {
        try {
          callback(...args);
        } catch (error) {
          console.error(`Error in ${event} handler:`, error);
        }
      });
    }
  }

  off(event, callback) {
    if (this.listeners.has(event)) {
      const callbacks = this.listeners.get(event);
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }
}

class PluginSystem {
  constructor() {
    this.plugins = new Map();
    this.events = new EventEmitter();
    this.coreElements = {};
    this.coreFunctions = {};
  }

  initializeCore() {
    // åˆå§‹åŒ–æ ¸å¿ƒå…ƒç´ å¼•ç”¨
    this.coreElements = {
      bookmarkTree: document.getElementById("bookmarkTree"),
      searchBox: document.querySelector(".search-box"),
      searchIcon: document.querySelector(".search-icon"),
      importBtn: document.getElementById("import-btn"),
      exportBtn: document.getElementById("export-btn"),
      loadBtn: document.getElementById("load-btn"),
      topBar: document.querySelector(".top-bar"),
      titleText: document.querySelector(".top-bar-title span"),
      topBarTitle: document.querySelector(".top-bar-title"),
      importModal: document.getElementById("import-modal"),
      modalBookmarkFile: document.getElementById("modal-bookmark-file"),
      modalUploadBtn: document.getElementById("modal-upload-btn")
    };

    // æ ¸å¿ƒåŠŸèƒ½
    this.coreFunctions = {
      loadBookmarks: this.loadBookmarks.bind(this),
      bindFolderClickEvents: this.bindFolderClickEvents.bind(this),
      createBookmarkList: this.createBookmarkList.bind(this),
      flattenNodes: this.flattenNodes.bind(this)
    };
  }

  registerPlugin(name, plugin) {
    if (this.plugins.has(name)) {
      console.warn(`Plugin ${name} already registered`);
      return false;
    }

    try {
      plugin.initialize({
        elements: this.coreElements,
        functions: this.coreFunctions,
        events: this.events
      });
      this.plugins.set(name, plugin);
      console.log(`Plugin ${name} registered successfully`);
      return true;
    } catch (error) {
      console.error(`Failed to initialize plugin ${name}:`, error);
      return false;
    }
  }

  unregisterPlugin(name) {
    if (this.plugins.has(name)) {
      try {
        this.plugins.get(name).destroy();
        this.plugins.delete(name);
        return true;
      } catch (error) {
        console.error(`Failed to destroy plugin ${name}:`, error);
        return false;
      }
    }
    return false;
  }

  getPlugin(name) {
    return this.plugins.get(name);
  }

  // æ ¸å¿ƒåŠŸèƒ½å®ç°
  async loadBookmarks(url) {
    // åŸæœ‰loadBookmarkså®ç°...
  }

  bindFolderClickEvents(calledFrom) {
    // åŸæœ‰bindFolderClickEventså®ç°...
  }

  createBookmarkList(node, level) {
    // åŸæœ‰createBookmarkListå®ç°...
  }

  flattenNodes(nodes, level) {
    // åŸæœ‰flattenNodeså®ç°...
  }
}

// å¯¼å‡ºå•ä¾‹å®ä¾‹
export const pluginSystem = new PluginSystem();
```

## 2\. æ’ä»¶æ¥å£å®ç°

åˆ›å»º `plugin-interface.js` æ–‡ä»¶ï¼š

```markdown
export class BasePlugin {
  constructor() {
    if (new.target === BasePlugin) {
      throw new Error("BasePlugin cannot be instantiated directly");
    }
    this.name = "UnnamedPlugin";
    this.version = "1.0.0";
    this.dependencies = [];
  }

  initialize({elements, functions, events}) {
    throw new Error("Plugin must implement initialize method");
  }

  destroy() {
    throw new Error("Plugin must implement destroy method");
  }

  log(message, level = "info") {
    const prefix = `[${this.name}]`;
    switch (level) {
      case "error":
        console.error(prefix, message);
        break;
      case "warn":
        console.warn(prefix, message);
        break;
      default:
        console.log(prefix, message);
    }
  }
}
```

## 3\. ç°æœ‰åŠŸèƒ½æ’ä»¶åŒ–æ”¹é€ 

### æœç´¢æ’ä»¶ (search-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class SearchPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = "SearchPlugin";
    this.version = "1.0.0";
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;
    this.functions = functions;

    this.setupSearch();
    this.bindEvents();

    this.log("Initialized successfully");
  }

  setupSearch() {
    this.searchResults = document.createElement("ul");
    this.searchResults.classList.add("search-results");
  }

  bindEvents() {
    // æœç´¢å›¾æ ‡ç‚¹å‡»äº‹ä»¶
    this.elements.searchIcon.addEventListener("click", () => {
      this.elements.searchIcon.style.display = "none";
      this.elements.searchBox.style.display = "block";
      this.elements.topBar.classList.add("searching");
      this.elements.searchBox.focus();

      if (window.innerWidth <= 480) {
        this.elements.titleText.style.display = "none";
      }
    });

    // æœç´¢æ¡†å¤±å»ç„¦ç‚¹äº‹ä»¶
    this.elements.searchBox.addEventListener("blur", () => {
      if (!this.elements.searchBox.value) {
        this.elements.searchBox.style.display = "none";
        this.elements.searchIcon.style.display = "block";
        this.elements.topBar.classList.remove("searching");

        if (window.innerWidth <= 480) {
          this.elements.titleText.style.display = "inline";
        }
      }
    });

    // æœç´¢è¾“å…¥äº‹ä»¶
    this.elements.searchBox.addEventListener("input", () => {
      this.handleSearchInput();
    });

    // æ ‡é¢˜ç‚¹å‡»äº‹ä»¶ - æ¸…é™¤æœç´¢
    this.elements.topBarTitle.addEventListener("click", () => {
      this.elements.searchBox.value = "";
      this.elements.searchBox.style.display = "none";
      this.elements.searchIcon.style.display = "block";
      this.elements.topBar.classList.remove("searching");
      this.elements.titleText.style.display = window.innerWidth <= 480 ? "inline" : "inline";
      this.events.emit("search-cleared");
    });
  }

  handleSearchInput() {
    const keyword = this.elements.searchBox.value.trim().toLowerCase();
    this.elements.bookmarkTree.innerHTML = "";

    if (keyword) {
      const regex = new RegExp(keyword, "gi");
      const results = this.functions.flattenNodes(this.currentData || [], 2)
        .filter(node =>
          node.title.toLowerCase().includes(keyword) ||
          (node.url && node.url.toLowerCase().includes(keyword))
        );

      this.displaySearchResults(results, regex);
    } else {
      this.events.emit("search-cleared");
    }
  }

  displaySearchResults(results, regex) {
    this.searchResults.innerHTML = "";

    results.forEach(result => {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.href = result.url || result.originalNode.url;
      a.classList.add("bookmark-link");
      a.target = "_blank";

      const highlightedTitle = result.title.replace(regex, `<mark>{{markdown}}</mark>`);
      a.innerHTML = highlightedTitle;

      const icon = document.createElement("img");
      icon.src = "https://www.google.com/s2/favicons?sz=32&domain_url=" +
                encodeURIComponent(result.url || result.originalNode.url);
      icon.classList.add("favicon-icon");
      a.prepend(icon);

      li.appendChild(a);
      this.searchResults.appendChild(li);
    });

    this.elements.bookmarkTree.appendChild(this.searchResults);
  }

  destroy() {
    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    this.elements.searchIcon.removeEventListener("click");
    this.elements.searchBox.removeEventListener("blur");
    this.elements.searchBox.removeEventListener("input");
    this.elements.topBarTitle.removeEventListener("click");

    this.log("Destroyed successfully");
  }
}
```

### æ–‡æœ¬å¤åˆ¶æ’ä»¶ (copy-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class CopyPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = "CopyPlugin";
    this.version = "1.0.0";
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    this.setupCopyHandlers();
    events.on('bookmark-rendered', this.updateCopyHandlers.bind(this));

    this.log("Initialized successfully");
  }

  setupCopyHandlers() {
    document.addEventListener('click', (e) => {
      if (e.target.closest('.bookmark-data-item')) {
        this.handleCopyClick(e);
      }
    });
  }

  updateCopyHandlers() {
    const dataItems = document.querySelectorAll('.bookmark-data-item');
    dataItems.forEach(item => {
      item.addEventListener('click', this.handleCopyClick.bind(this));
    });
  }

  handleCopyClick(e) {
    e.preventDefault();
    e.stopPropagation();

    const wrapper = e.target.closest('.bookmark-data-item');
    if (!wrapper) return;

    const copyIcon = wrapper.querySelector('.copy-symbol');
    const text = wrapper.querySelector('.copyable');
    const node = this.findNodeByTitle(text.textContent);

    if (!node || !node.url) return;

    try {
      const html = decodeURIComponent(node.url.split(",")[1]);
      const match = html.match(/<pre>([\s\S]*?)<\/pre>/i);
      if (match) {
        const content = match[1]
          .replace(/&lt;/g, "<")
          .replace(/&gt;/g, ">")
          .replace(/&amp;/g, "&");

        navigator.clipboard.writeText(content).then(() => {
          copyIcon.textContent = "âœ…";
          wrapper.classList.add("copied");
          setTimeout(() => {
            copyIcon.textContent = "ğŸ“‹";
            wrapper.classList.remove("copied");
          }, 2000);
        });
      }
    } catch (error) {
      this.log(`Copy failed: ${error.message}`, 'error');
    }
  }

  findNodeByTitle(title) {
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æœç´¢å½“å‰æ˜¾ç¤ºçš„ä¹¦ç­¾æ•°æ®
    return null;
  }

  destroy() {
    document.removeEventListener('click', this.handleCopyClick);
    this.events.off('bookmark-rendered', this.updateCopyHandlers);
    this.log("Destroyed successfully");
  }
}
```

### æ–‡ä»¶ä¸Šä¼ æ’ä»¶ (upload-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class UploadPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = "UploadPlugin";
    this.version = "1.0.0";
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    this.setupUpload();
    events.on('data-loaded', this.handleNewData.bind(this));

    this.log("Initialized successfully");
  }

  setupUpload() {
    // æ–‡ä»¶é€‰æ‹©å˜åŒ–äº‹ä»¶
    this.elements.modalBookmarkFile.addEventListener("change", () => {
      this.handleFileSelect();
    });

    // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    this.elements.modalUploadBtn.addEventListener("click", async () => {
      await this.handleUpload();
    });
  }

  handleFileSelect() {
    const file = this.elements.modalBookmarkFile.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      this.events.emit('file-selected', e.target.result);
    };
    reader.readAsText(file);
  }

  async handleUpload() {
    const token = prompt("è¯·è¾“å…¥ GitHub Tokenï¼š");
    if (!token) {
      alert("âŒ æœªæä¾› Tokenï¼Œä¸Šä¼ å·²å–æ¶ˆ");
      return;
    }

    try {
      const repo = "fjvi/bookmark";
      const path = "data/bookmarks.json";
      const branch = "main";
      const getURL = `https://api.github.com/repos/${repo}/contents/${path}`;
      let sha = null;

      // è·å–ç°æœ‰æ–‡ä»¶çš„SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const res = await fetch(getURL, {
        headers: { Authorization: "token " + token }
      });

      if (res.ok) {
        const json = await res.json();
        sha = json.sha;
      }

      // å‡†å¤‡ä¸Šä¼ å†…å®¹
      const content = btoa(unescape(encodeURIComponent(this.currentData)));
      const payload = {
        message: "æ›´æ–°ä¹¦ç­¾ JSON",
        content,
        branch,
        ...(sha && { sha })
      };

      // æ‰§è¡Œä¸Šä¼ 
      const uploadRes = await fetch(getURL, {
        method: "PUT",
        headers: {
          Authorization: "token " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (uploadRes.ok) {
        alert("âœ… ä¸Šä¼ æˆåŠŸï¼");
        this.events.emit('upload-success');
      } else {
        throw new Error("ä¸Šä¼ å¤±è´¥");
      }
    } catch (error) {
      this.log(`Upload failed: ${error.message}`, 'error');
      alert("âŒ ä¸Šä¼ å¤±è´¥");
    }
  }

  handleNewData(data) {
    this.currentData = JSON.stringify(data, null, 2);
  }

  destroy() {
    this.elements.modalBookmarkFile.removeEventListener("change", this.handleFileSelect);
    this.elements.modalUploadBtn.removeEventListener("click", this.handleUpload);
    this.events.off('data-loaded', this.handleNewData);
    this.log("Destroyed successfully");
  }
}
```

## 4\. ä¸»åº”ç”¨æ”¹é€  (main.js)

```markdown
import { pluginSystem } from './plugin-system.js';
import { SearchPlugin } from './search-plugin.js';
import { CopyPlugin } from './copy-plugin.js';
import { UploadPlugin } from './upload-plugin.js';
import { FaviconPlugin } from './favicon-plugin.js';
import { LoaderPlugin } from './loader-plugin.js';

// åˆå§‹åŒ–æ’ä»¶ç³»ç»Ÿ
document.addEventListener('DOMContentLoaded', async () => {
  // åˆå§‹åŒ–æ ¸å¿ƒç³»ç»Ÿ
  pluginSystem.initializeCore();

  // æ³¨å†Œæ’ä»¶
  pluginSystem.registerPlugin('search', new SearchPlugin());
  pluginSystem.registerPlugin('copy', new CopyPlugin());
  pluginSystem.registerPlugin('upload', new UploadPlugin());
  pluginSystem.registerPlugin('favicons', new FaviconPlugin());
  pluginSystem.registerPlugin('loader', new LoaderPlugin());

  // åŠ è½½åˆå§‹æ•°æ®
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const dataUrl = urlParams.get('data') || "data/bookmarks.json";
    await pluginSystem.loadBookmarks(dataUrl);
  } catch (error) {
    console.error("Initial load failed:", error);
    alert(`âš ï¸ æ— æ³•åŠ è½½ä¹¦ç­¾: ${error.message}\næ‚¨å¯ä»¥ç‚¹å‡»"å¯¼å…¥ä¹¦ç­¾"æ‰‹åŠ¨ä¸Šä¼ ã€‚`);
  }
});
```

## 5\. å®æ–½è¯´æ˜

### å®æ–½æ­¥éª¤

1.  **åˆ›å»ºæ’ä»¶ç³»ç»Ÿæ–‡ä»¶ç»“æ„**

    ```markdown
    /plugins
      â”œâ”€â”€ plugin-system.js      # æ ¸å¿ƒæ’ä»¶ç³»ç»Ÿ
      â”œâ”€â”€ plugin-interface.js   # åŸºç¡€æ’ä»¶æ¥å£
      â”œâ”€â”€ search-plugin.js      # æœç´¢åŠŸèƒ½æ’ä»¶
      â”œâ”€â”€ copy-plugin.js        # æ–‡æœ¬å¤åˆ¶æ’ä»¶
      â”œâ”€â”€ upload-plugin.js      # æ–‡ä»¶ä¸Šä¼ æ’ä»¶
      â”œâ”€â”€ favicon-plugin.js     # å›¾æ ‡æ’ä»¶
      â””â”€â”€ loader-plugin.js      # åŠ è½½åŠŸèƒ½æ’ä»¶
    ```

2.  **ä¿®æ”¹HTMLæ–‡ä»¶**

    - æ›´æ–°scriptæ ‡ç­¾å¼•ç”¨æ–°çš„ä¸»æ–‡ä»¶
    - ç¡®ä¿æ‰€æœ‰å¿…è¦çš„DOMå…ƒç´ æœ‰æ­£ç¡®çš„ID/class

3.  **é€æ­¥è¿ç§»åŠŸèƒ½**

    - é¦–å…ˆå®ç°æ ¸å¿ƒç³»ç»Ÿ
    - ç„¶åé€ä¸ªå°†ç°æœ‰åŠŸèƒ½è¿ç§»åˆ°æ’ä»¶ä¸­
    - æµ‹è¯•æ¯ä¸ªæ’ä»¶ç‹¬ç«‹å·¥ä½œ

4.  **æµ‹è¯•ä¸éªŒè¯**

    - ç¡®ä¿æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
    - éªŒè¯æ’ä»¶å¯ä»¥ç‹¬ç«‹å¯ç”¨/ç¦ç”¨
    - æ£€æŸ¥æ€§èƒ½å½±å“

### ç»´æŠ¤å»ºè®®

1.  **æ’ä»¶å¼€å‘è§„èŒƒ**

    - æ¯ä¸ªæ’ä»¶å•ç‹¬æ–‡ä»¶
    - æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
    - æ¸…æ™°çš„ä¾èµ–å£°æ˜
    - å®Œå–„çš„é”™è¯¯å¤„ç†

2.  **ç‰ˆæœ¬ç®¡ç†**

    - æ’ä»¶ç‰ˆæœ¬å·éµå¾ªsemver
    - æ ¸å¿ƒç³»ç»Ÿä¸æ’ä»¶ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

3.  **æ–‡æ¡£è¦æ±‚**

    - æ¯ä¸ªæ’ä»¶é¡¶éƒ¨æœ‰ä½¿ç”¨è¯´æ˜
    - äº‹ä»¶APIæ–‡æ¡£
    - é…ç½®é€‰é¡¹è¯´æ˜

### æ‰©å±•æ€§è®¾è®¡

1.  **åŠ¨æ€åŠ è½½æ’ä»¶**

    ```markdown
    async function loadExternalPlugin(url) {
      try {
        const module = await import(url);
        if (module && module.default) {
          const plugin = new module.default();
          pluginSystem.registerPlugin(plugin.name, plugin);
        }
      } catch (error) {
        console.error('Failed to load plugin:', error);
      }
    }
    ```

2.  **æ’ä»¶é…ç½®ç•Œé¢**

    - å¯ä»¥æ·»åŠ ä¸€ä¸ªé…ç½®ç®¡ç†æ’ä»¶
    - æä¾›UIç•Œé¢è°ƒæ•´æ’ä»¶è®¾ç½®

3.  **æ’ä»¶é—´é€šä¿¡**

    - é€šè¿‡äº‹ä»¶ç³»ç»Ÿè¿›è¡Œé€šä¿¡
    - é¿å…ç›´æ¥ä¾èµ–å…¶ä»–æ’ä»¶

è¿™å¥—å®ç°å®Œæ•´ä¿ç•™äº†åŸæœ‰æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒæ—¶æä¾›äº†æ›´å¥½çš„æ¶æ„å’Œæ‰©å±•æ€§ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€è¦é€æ­¥å®æ–½ï¼Œå…ˆä»æ ¸å¿ƒç³»ç»Ÿå’Œ1-2ä¸ªç®€å•æ’ä»¶å¼€å§‹ï¼ŒéªŒè¯æ¶æ„åå†è¿ç§»å…¶ä»–åŠŸèƒ½ã€‚

