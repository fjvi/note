<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    
    <link rel="icon" href="../favicon.ico"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="## 插件加载器完整实施方案

下面我将提供完整的代码实现方案，包括核心系统、插件接口和现有功能的插件化改造。

## 1\. 核心系统实现

创建 `plugin-system.js` 文件：

```markdown
class EventEmitter {
  constructor() {
    this.listeners = new Map();
  }

  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event).push(callback);
  }

  emit(event, ...args) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback => {
        try {
          callback(...args);
        } catch (error) {
          console.error(`Error in ${event} handler:`, error);
        }
      });
    }
  }

  off(event, callback) {
    if (this.listeners.has(event)) {
      const callbacks = this.listeners.get(event);
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }
}

class PluginSystem {
  constructor() {
    this.plugins = new Map();
    this.events = new EventEmitter();
    this.coreElements = {};
    this.coreFunctions = {};
  }

  initializeCore() {
    // 初始化核心元素引用
    this.coreElements = {
      bookmarkTree: document.getElementById('bookmarkTree'),
      searchBox: document.querySelector('.search-box'),
      searchIcon: document.querySelector('.search-icon'),
      importBtn: document.getElementById('import-btn'),
      exportBtn: document.getElementById('export-btn'),
      loadBtn: document.getElementById('load-btn'),
      topBar: document.querySelector('.top-bar'),
      titleText: document.querySelector('.top-bar-title span'),
      topBarTitle: document.querySelector('.top-bar-title'),
      importModal: document.getElementById('import-modal'),
      modalBookmarkFile: document.getElementById('modal-bookmark-file'),
      modalUploadBtn: document.getElementById('modal-upload-btn')
    };

    // 核心功能
    this.coreFunctions = {
      loadBookmarks: this.loadBookmarks.bind(this),
      bindFolderClickEvents: this.bindFolderClickEvents.bind(this),
      createBookmarkList: this.createBookmarkList.bind(this),
      flattenNodes: this.flattenNodes.bind(this)
    };
  }

  registerPlugin(name, plugin) {
    if (this.plugins.has(name)) {
      console.warn(`Plugin ${name} already registered`);
      return false;
    }

    try {
      plugin.initialize({
        elements: this.coreElements,
        functions: this.coreFunctions,
        events: this.events
      });
      this.plugins.set(name, plugin);
      console.log(`Plugin ${name} registered successfully`);
      return true;
    } catch (error) {
      console.error(`Failed to initialize plugin ${name}:`, error);
      return false;
    }
  }

  unregisterPlugin(name) {
    if (this.plugins.has(name)) {
      try {
        this.plugins.get(name).destroy();
        this.plugins.delete(name);
        return true;
      } catch (error) {
        console.error(`Failed to destroy plugin ${name}:`, error);
        return false;
      }
    }
    return false;
  }

  getPlugin(name) {
    return this.plugins.get(name);
  }

  // 核心功能实现
  async loadBookmarks(url) {
    // 原有loadBookmarks实现...
  }

  bindFolderClickEvents(calledFrom) {
    // 原有bindFolderClickEvents实现...
  }

  createBookmarkList(node, level) {
    // 原有createBookmarkList实现...
  }

  flattenNodes(nodes, level) {
    // 原有flattenNodes实现...
  }
}

// 导出单例实例
export const pluginSystem = new PluginSystem();
```

## 2\. 插件接口实现

创建 `plugin-interface.js` 文件：

```markdown
export class BasePlugin {
  constructor() {
    if (new.target === BasePlugin) {
      throw new Error('BasePlugin cannot be instantiated directly');
    }
    this.name = 'UnnamedPlugin';
    this.version = '1.0.0';
    this.dependencies = [];
  }

  initialize({elements, functions, events}) {
    throw new Error('Plugin must implement initialize method');
  }

  destroy() {
    throw new Error('Plugin must implement destroy method');
  }

  log(message, level = 'info') {
    const prefix = `[${this.name}]`;
    switch (level) {
      case 'error':
        console.error(prefix, message);
        break;
      case 'warn':
        console.warn(prefix, message);
        break;
      default:
        console.log(prefix, message);
    }
  }
}
```

## 3\. 现有功能插件化改造

### 搜索插件 (search-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class SearchPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = 'SearchPlugin';
    this.version = '1.0.0';
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;
    this.functions = functions;

    this.setupSearch();
    this.bindEvents();

    this.log('Initialized successfully');
  }

  setupSearch() {
    this.searchResults = document.createElement('ul');
    this.searchResults.classList.add('search-results');
  }

  bindEvents() {
    // 搜索图标点击事件
    this.elements.searchIcon.addEventListener('click', () => {
      this.elements.searchIcon.style.display = 'none';
      this.elements.searchBox.style.display = 'block';
      this.elements.topBar.classList.add('searching');
      this.elements.searchBox.focus();

      if (window.innerWidth <= 480) {
        this.elements.titleText.style.display = 'none';
      }
    });

    // 搜索框失去焦点事件
    this.elements.searchBox.addEventListener('blur', () => {
      if (!this.elements.searchBox.value) {
        this.elements.searchBox.style.display = 'none';
        this.elements.searchIcon.style.display = 'block';
        this.elements.topBar.classList.remove('searching');

        if (window.innerWidth <= 480) {
          this.elements.titleText.style.display = 'inline';
        }
      }
    });

    // 搜索输入事件
    this.elements.searchBox.addEventListener('input', () => {
      this.handleSearchInput();
    });

    // 标题点击事件 - 清除搜索
    this.elements.topBarTitle.addEventListener('click', () => {
      this.elements.searchBox.value = '';
      this.elements.searchBox.style.display = 'none';
      this.elements.searchIcon.style.display = 'block';
      this.elements.topBar.classList.remove('searching');
      this.elements.titleText.style.display = window.innerWidth <= 480 ? 'inline' : 'inline';
      this.events.emit('search-cleared');
    });
  }

  handleSearchInput() {
    const keyword = this.elements.searchBox.value.trim().toLowerCase();
    this.elements.bookmarkTree.innerHTML = '';

    if (keyword) {
      const regex = new RegExp(keyword, 'gi');
      const results = this.functions.flattenNodes(this.currentData || [], 2)
        .filter(node =>
          node.title.toLowerCase().includes(keyword) ||
          (node.url && node.url.toLowerCase().includes(keyword))
        );

      this.displaySearchResults(results, regex);
    } else {
      this.events.emit('search-cleared');
    }
  }

  displaySearchResults(results, regex) {
    this.searchResults.innerHTML = '';

    results.forEach(result => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = result.url || result.originalNode.url;
      a.classList.add('bookmark-link');
      a.target = '_blank';

      const highlightedTitle = result.title.replace(regex, `<mark>{{markdown}}</mark>`);
      a.innerHTML = highlightedTitle;

      const icon = document.createElement('img');
      icon.src = 'https://www.google.com/s2/favicons?sz=32&domain_url=' +
                encodeURIComponent(result.url || result.originalNode.url);
      icon.classList.add('favicon-icon');
      a.prepend(icon);

      li.appendChild(a);
      this.searchResults.appendChild(li);
    });

    this.elements.bookmarkTree.appendChild(this.searchResults);
  }

  destroy() {
    // 清理事件监听器
    this.elements.searchIcon.removeEventListener('click');
    this.elements.searchBox.removeEventListener('blur');
    this.elements.searchBox.removeEventListener('input');
    this.elements.topBarTitle.removeEventListener('click');

    this.log('Destroyed successfully');
  }
}
```

### 文本复制插件 (copy-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class CopyPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = 'CopyPlugin';
    this.version = '1.0.0';
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    this.setupCopyHandlers();
    events.on('bookmark-rendered', this.updateCopyHandlers.bind(this));

    this.log('Initialized successfully');
  }

  setupCopyHandlers() {
    document.addEventListener('click', (e) => {
      if (e.target.closest('.bookmark-data-item')) {
        this.handleCopyClick(e);
      }
    });
  }

  updateCopyHandlers() {
    const dataItems = document.querySelectorAll('.bookmark-data-item');
    dataItems.forEach(item => {
      item.addEventListener('click', this.handleCopyClick.bind(this));
    });
  }

  handleCopyClick(e) {
    e.preventDefault();
    e.stopPropagation();

    const wrapper = e.target.closest('.bookmark-data-item');
    if (!wrapper) return;

    const copyIcon = wrapper.querySelector('.copy-symbol');
    const text = wrapper.querySelector('.copyable');
    const node = this.findNodeByTitle(text.textContent);

    if (!node || !node.url) return;

    try {
      const html = decodeURIComponent(node.url.split(',')[1]);
      const match = html.match(/<pre>([\s\S]*?)<\/pre>/i);
      if (match) {
        const content = match[1]
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&');

        navigator.clipboard.writeText(content).then(() => {
          copyIcon.textContent = '✅';
          wrapper.classList.add('copied');
          setTimeout(() => {
            copyIcon.textContent = '📋';
            wrapper.classList.remove('copied');
          }, 2000);
        });
      }
    } catch (error) {
      this.log(`Copy failed: ${error.message}`, 'error');
    }
  }

  findNodeByTitle(title) {
    // 在实际应用中，这里应该搜索当前显示的书签数据
    return null;
  }

  destroy() {
    document.removeEventListener('click', this.handleCopyClick);
    this.events.off('bookmark-rendered', this.updateCopyHandlers);
    this.log('Destroyed successfully');
  }
}
```

### 文件上传插件 (upload-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class UploadPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = 'UploadPlugin';
    this.version = '1.0.0';
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    this.setupUpload();
    events.on('data-loaded', this.handleNewData.bind(this));

    this.log('Initialized successfully');
  }

  setupUpload() {
    // 文件选择变化事件
    this.elements.modalBookmarkFile.addEventListener('change', () => {
      this.handleFileSelect();
    });

    // 上传按钮点击事件
    this.elements.modalUploadBtn.addEventListener('click', async () => {
      await this.handleUpload();
    });
  }

  handleFileSelect() {
    const file = this.elements.modalBookmarkFile.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      this.events.emit('file-selected', e.target.result);
    };
    reader.readAsText(file);
  }

  async handleUpload() {
    const token = prompt('请输入 GitHub Token：');
    if (!token) {
      alert('❌ 未提供 Token，上传已取消');
      return;
    }

    try {
      const repo = 'fjvi/bookmark';
      const path = 'data/bookmarks.json';
      const branch = 'main';
      const getURL = `https://api.github.com/repos/${repo}/contents/${path}`;
      let sha = null;

      // 获取现有文件的SHA（如果存在）
      const res = await fetch(getURL, {
        headers: { Authorization: 'token ' + token }
      });

      if (res.ok) {
        const json = await res.json();
        sha = json.sha;
      }

      // 准备上传内容
      const content = btoa(unescape(encodeURIComponent(this.currentData)));
      const payload = {
        message: '更新书签 JSON',
        content,
        branch,
        ...(sha && { sha })
      };

      // 执行上传
      const uploadRes = await fetch(getURL, {
        method: 'PUT',
        headers: {
          Authorization: 'token ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (uploadRes.ok) {
        alert('✅ 上传成功！');
        this.events.emit('upload-success');
      } else {
        throw new Error('上传失败');
      }
    } catch (error) {
      this.log(`Upload failed: ${error.message}`, 'error');
      alert('❌ 上传失败');
    }
  }

  handleNewData(data) {
    this.currentData = JSON.stringify(data, null, 2);
  }

  destroy() {
    this.elements.modalBookmarkFile.removeEventListener('change', this.handleFileSelect);
    this.elements.modalUploadBtn.removeEventListener('click', this.handleUpload);
    this.events.off('data-loaded', this.handleNewData);
    this.log('Destroyed successfully');
  }
}
```

## 4\. 主应用改造 (main.js)

```markdown
import { pluginSystem } from './plugin-system.js';
import { SearchPlugin } from './search-plugin.js';
import { CopyPlugin } from './copy-plugin.js';
import { UploadPlugin } from './upload-plugin.js';
import { FaviconPlugin } from './favicon-plugin.js';
import { LoaderPlugin } from './loader-plugin.js';

// 初始化插件系统
document.addEventListener('DOMContentLoaded', async () => {
  // 初始化核心系统
  pluginSystem.initializeCore();

  // 注册插件
  pluginSystem.registerPlugin('search', new SearchPlugin());
  pluginSystem.registerPlugin('copy', new CopyPlugin());
  pluginSystem.registerPlugin('upload', new UploadPlugin());
  pluginSystem.registerPlugin('favicons', new FaviconPlugin());
  pluginSystem.registerPlugin('loader', new LoaderPlugin());

  // 加载初始数据
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const dataUrl = urlParams.get('data') || 'data/bookmarks.json';
    await pluginSystem.loadBookmarks(dataUrl);
  } catch (error) {
    console.error('Initial load failed:', error);
    alert(`⚠️ 无法加载书签: ${error.message}\n您可以点击'导入书签'手动上传。`);
  }
});
```

## 5\. 实施说明

### 实施步骤

1.  **创建插件系统文件结构**

    ```markdown
    /plugins
      ├── plugin-system.js      # 核心插件系统
      ├── plugin-interface.js   # 基础插件接口
      ├── search-plugin.js      # 搜索功能插件
      ├── copy-plugin.js        # 文本复制插件
      ├── upload-plugin.js      # 文件上传插件
      ├── favicon-plugin.js     # 图标插件
      └── loader-plugin.js      # 加载功能插件
    ```

2.  **修改HTML文件**

    - 更新script标签引用新的主文件
    - 确保所有必要的DOM元素有正确的ID/class

3.  **逐步迁移功能**

    - 首先实现核心系统
    - 然后逐个将现有功能迁移到插件中
    - 测试每个插件独立工作

4.  **测试与验证**

    - 确保所有原有功能正常工作
    - 验证插件可以独立启用/禁用
    - 检查性能影响

### 维护建议

1.  **插件开发规范**

    - 每个插件单独文件
    - 明确的生命周期方法
    - 清晰的依赖声明
    - 完善的错误处理

2.  **版本管理**

    - 插件版本号遵循semver
    - 核心系统与插件版本兼容性检查

3.  **文档要求**

    - 每个插件顶部有使用说明
    - 事件API文档
    - 配置选项说明

### 扩展性设计

1.  **动态加载插件**

    ```markdown
    async function loadExternalPlugin(url) {
      try {
        const module = await import(url);
        if (module && module.default) {
          const plugin = new module.default();
          pluginSystem.registerPlugin(plugin.name, plugin);
        }
      } catch (error) {
        console.error('Failed to load plugin:', error);
      }
    }
    ```

2.  **插件配置界面**

    - 可以添加一个配置管理插件
    - 提供UI界面调整插件设置

3.  **插件间通信**

    - 通过事件系统进行通信
    - 避免直接依赖其他插件

这套实现完整保留了原有所有功能，同时提供了更好的架构和扩展性。您可以根据需要逐步实施，先从核心系统和1-2个简单插件开始，验证架构后再迁移其他功能。

$$$$$$$">
<meta property="og:title" content="插件加载器完整实施方案">
<meta property="og:description" content="## 插件加载器完整实施方案

下面我将提供完整的代码实现方案，包括核心系统、插件接口和现有功能的插件化改造。

## 1\. 核心系统实现

创建 `plugin-system.js` 文件：

```markdown
class EventEmitter {
  constructor() {
    this.listeners = new Map();
  }

  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event).push(callback);
  }

  emit(event, ...args) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback => {
        try {
          callback(...args);
        } catch (error) {
          console.error(`Error in ${event} handler:`, error);
        }
      });
    }
  }

  off(event, callback) {
    if (this.listeners.has(event)) {
      const callbacks = this.listeners.get(event);
      const index = callbacks.indexOf(callback);
      if (index > -1) {
        callbacks.splice(index, 1);
      }
    }
  }
}

class PluginSystem {
  constructor() {
    this.plugins = new Map();
    this.events = new EventEmitter();
    this.coreElements = {};
    this.coreFunctions = {};
  }

  initializeCore() {
    // 初始化核心元素引用
    this.coreElements = {
      bookmarkTree: document.getElementById('bookmarkTree'),
      searchBox: document.querySelector('.search-box'),
      searchIcon: document.querySelector('.search-icon'),
      importBtn: document.getElementById('import-btn'),
      exportBtn: document.getElementById('export-btn'),
      loadBtn: document.getElementById('load-btn'),
      topBar: document.querySelector('.top-bar'),
      titleText: document.querySelector('.top-bar-title span'),
      topBarTitle: document.querySelector('.top-bar-title'),
      importModal: document.getElementById('import-modal'),
      modalBookmarkFile: document.getElementById('modal-bookmark-file'),
      modalUploadBtn: document.getElementById('modal-upload-btn')
    };

    // 核心功能
    this.coreFunctions = {
      loadBookmarks: this.loadBookmarks.bind(this),
      bindFolderClickEvents: this.bindFolderClickEvents.bind(this),
      createBookmarkList: this.createBookmarkList.bind(this),
      flattenNodes: this.flattenNodes.bind(this)
    };
  }

  registerPlugin(name, plugin) {
    if (this.plugins.has(name)) {
      console.warn(`Plugin ${name} already registered`);
      return false;
    }

    try {
      plugin.initialize({
        elements: this.coreElements,
        functions: this.coreFunctions,
        events: this.events
      });
      this.plugins.set(name, plugin);
      console.log(`Plugin ${name} registered successfully`);
      return true;
    } catch (error) {
      console.error(`Failed to initialize plugin ${name}:`, error);
      return false;
    }
  }

  unregisterPlugin(name) {
    if (this.plugins.has(name)) {
      try {
        this.plugins.get(name).destroy();
        this.plugins.delete(name);
        return true;
      } catch (error) {
        console.error(`Failed to destroy plugin ${name}:`, error);
        return false;
      }
    }
    return false;
  }

  getPlugin(name) {
    return this.plugins.get(name);
  }

  // 核心功能实现
  async loadBookmarks(url) {
    // 原有loadBookmarks实现...
  }

  bindFolderClickEvents(calledFrom) {
    // 原有bindFolderClickEvents实现...
  }

  createBookmarkList(node, level) {
    // 原有createBookmarkList实现...
  }

  flattenNodes(nodes, level) {
    // 原有flattenNodes实现...
  }
}

// 导出单例实例
export const pluginSystem = new PluginSystem();
```

## 2\. 插件接口实现

创建 `plugin-interface.js` 文件：

```markdown
export class BasePlugin {
  constructor() {
    if (new.target === BasePlugin) {
      throw new Error('BasePlugin cannot be instantiated directly');
    }
    this.name = 'UnnamedPlugin';
    this.version = '1.0.0';
    this.dependencies = [];
  }

  initialize({elements, functions, events}) {
    throw new Error('Plugin must implement initialize method');
  }

  destroy() {
    throw new Error('Plugin must implement destroy method');
  }

  log(message, level = 'info') {
    const prefix = `[${this.name}]`;
    switch (level) {
      case 'error':
        console.error(prefix, message);
        break;
      case 'warn':
        console.warn(prefix, message);
        break;
      default:
        console.log(prefix, message);
    }
  }
}
```

## 3\. 现有功能插件化改造

### 搜索插件 (search-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class SearchPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = 'SearchPlugin';
    this.version = '1.0.0';
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;
    this.functions = functions;

    this.setupSearch();
    this.bindEvents();

    this.log('Initialized successfully');
  }

  setupSearch() {
    this.searchResults = document.createElement('ul');
    this.searchResults.classList.add('search-results');
  }

  bindEvents() {
    // 搜索图标点击事件
    this.elements.searchIcon.addEventListener('click', () => {
      this.elements.searchIcon.style.display = 'none';
      this.elements.searchBox.style.display = 'block';
      this.elements.topBar.classList.add('searching');
      this.elements.searchBox.focus();

      if (window.innerWidth <= 480) {
        this.elements.titleText.style.display = 'none';
      }
    });

    // 搜索框失去焦点事件
    this.elements.searchBox.addEventListener('blur', () => {
      if (!this.elements.searchBox.value) {
        this.elements.searchBox.style.display = 'none';
        this.elements.searchIcon.style.display = 'block';
        this.elements.topBar.classList.remove('searching');

        if (window.innerWidth <= 480) {
          this.elements.titleText.style.display = 'inline';
        }
      }
    });

    // 搜索输入事件
    this.elements.searchBox.addEventListener('input', () => {
      this.handleSearchInput();
    });

    // 标题点击事件 - 清除搜索
    this.elements.topBarTitle.addEventListener('click', () => {
      this.elements.searchBox.value = '';
      this.elements.searchBox.style.display = 'none';
      this.elements.searchIcon.style.display = 'block';
      this.elements.topBar.classList.remove('searching');
      this.elements.titleText.style.display = window.innerWidth <= 480 ? 'inline' : 'inline';
      this.events.emit('search-cleared');
    });
  }

  handleSearchInput() {
    const keyword = this.elements.searchBox.value.trim().toLowerCase();
    this.elements.bookmarkTree.innerHTML = '';

    if (keyword) {
      const regex = new RegExp(keyword, 'gi');
      const results = this.functions.flattenNodes(this.currentData || [], 2)
        .filter(node =>
          node.title.toLowerCase().includes(keyword) ||
          (node.url && node.url.toLowerCase().includes(keyword))
        );

      this.displaySearchResults(results, regex);
    } else {
      this.events.emit('search-cleared');
    }
  }

  displaySearchResults(results, regex) {
    this.searchResults.innerHTML = '';

    results.forEach(result => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = result.url || result.originalNode.url;
      a.classList.add('bookmark-link');
      a.target = '_blank';

      const highlightedTitle = result.title.replace(regex, `<mark>{{markdown}}</mark>`);
      a.innerHTML = highlightedTitle;

      const icon = document.createElement('img');
      icon.src = 'https://www.google.com/s2/favicons?sz=32&domain_url=' +
                encodeURIComponent(result.url || result.originalNode.url);
      icon.classList.add('favicon-icon');
      a.prepend(icon);

      li.appendChild(a);
      this.searchResults.appendChild(li);
    });

    this.elements.bookmarkTree.appendChild(this.searchResults);
  }

  destroy() {
    // 清理事件监听器
    this.elements.searchIcon.removeEventListener('click');
    this.elements.searchBox.removeEventListener('blur');
    this.elements.searchBox.removeEventListener('input');
    this.elements.topBarTitle.removeEventListener('click');

    this.log('Destroyed successfully');
  }
}
```

### 文本复制插件 (copy-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class CopyPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = 'CopyPlugin';
    this.version = '1.0.0';
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    this.setupCopyHandlers();
    events.on('bookmark-rendered', this.updateCopyHandlers.bind(this));

    this.log('Initialized successfully');
  }

  setupCopyHandlers() {
    document.addEventListener('click', (e) => {
      if (e.target.closest('.bookmark-data-item')) {
        this.handleCopyClick(e);
      }
    });
  }

  updateCopyHandlers() {
    const dataItems = document.querySelectorAll('.bookmark-data-item');
    dataItems.forEach(item => {
      item.addEventListener('click', this.handleCopyClick.bind(this));
    });
  }

  handleCopyClick(e) {
    e.preventDefault();
    e.stopPropagation();

    const wrapper = e.target.closest('.bookmark-data-item');
    if (!wrapper) return;

    const copyIcon = wrapper.querySelector('.copy-symbol');
    const text = wrapper.querySelector('.copyable');
    const node = this.findNodeByTitle(text.textContent);

    if (!node || !node.url) return;

    try {
      const html = decodeURIComponent(node.url.split(',')[1]);
      const match = html.match(/<pre>([\s\S]*?)<\/pre>/i);
      if (match) {
        const content = match[1]
          .replace(/&lt;/g, '<')
          .replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&');

        navigator.clipboard.writeText(content).then(() => {
          copyIcon.textContent = '✅';
          wrapper.classList.add('copied');
          setTimeout(() => {
            copyIcon.textContent = '📋';
            wrapper.classList.remove('copied');
          }, 2000);
        });
      }
    } catch (error) {
      this.log(`Copy failed: ${error.message}`, 'error');
    }
  }

  findNodeByTitle(title) {
    // 在实际应用中，这里应该搜索当前显示的书签数据
    return null;
  }

  destroy() {
    document.removeEventListener('click', this.handleCopyClick);
    this.events.off('bookmark-rendered', this.updateCopyHandlers);
    this.log('Destroyed successfully');
  }
}
```

### 文件上传插件 (upload-plugin.js)

```markdown
import { BasePlugin } from './plugin-interface.js';

export class UploadPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = 'UploadPlugin';
    this.version = '1.0.0';
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    this.setupUpload();
    events.on('data-loaded', this.handleNewData.bind(this));

    this.log('Initialized successfully');
  }

  setupUpload() {
    // 文件选择变化事件
    this.elements.modalBookmarkFile.addEventListener('change', () => {
      this.handleFileSelect();
    });

    // 上传按钮点击事件
    this.elements.modalUploadBtn.addEventListener('click', async () => {
      await this.handleUpload();
    });
  }

  handleFileSelect() {
    const file = this.elements.modalBookmarkFile.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      this.events.emit('file-selected', e.target.result);
    };
    reader.readAsText(file);
  }

  async handleUpload() {
    const token = prompt('请输入 GitHub Token：');
    if (!token) {
      alert('❌ 未提供 Token，上传已取消');
      return;
    }

    try {
      const repo = 'fjvi/bookmark';
      const path = 'data/bookmarks.json';
      const branch = 'main';
      const getURL = `https://api.github.com/repos/${repo}/contents/${path}`;
      let sha = null;

      // 获取现有文件的SHA（如果存在）
      const res = await fetch(getURL, {
        headers: { Authorization: 'token ' + token }
      });

      if (res.ok) {
        const json = await res.json();
        sha = json.sha;
      }

      // 准备上传内容
      const content = btoa(unescape(encodeURIComponent(this.currentData)));
      const payload = {
        message: '更新书签 JSON',
        content,
        branch,
        ...(sha && { sha })
      };

      // 执行上传
      const uploadRes = await fetch(getURL, {
        method: 'PUT',
        headers: {
          Authorization: 'token ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (uploadRes.ok) {
        alert('✅ 上传成功！');
        this.events.emit('upload-success');
      } else {
        throw new Error('上传失败');
      }
    } catch (error) {
      this.log(`Upload failed: ${error.message}`, 'error');
      alert('❌ 上传失败');
    }
  }

  handleNewData(data) {
    this.currentData = JSON.stringify(data, null, 2);
  }

  destroy() {
    this.elements.modalBookmarkFile.removeEventListener('change', this.handleFileSelect);
    this.elements.modalUploadBtn.removeEventListener('click', this.handleUpload);
    this.events.off('data-loaded', this.handleNewData);
    this.log('Destroyed successfully');
  }
}
```

## 4\. 主应用改造 (main.js)

```markdown
import { pluginSystem } from './plugin-system.js';
import { SearchPlugin } from './search-plugin.js';
import { CopyPlugin } from './copy-plugin.js';
import { UploadPlugin } from './upload-plugin.js';
import { FaviconPlugin } from './favicon-plugin.js';
import { LoaderPlugin } from './loader-plugin.js';

// 初始化插件系统
document.addEventListener('DOMContentLoaded', async () => {
  // 初始化核心系统
  pluginSystem.initializeCore();

  // 注册插件
  pluginSystem.registerPlugin('search', new SearchPlugin());
  pluginSystem.registerPlugin('copy', new CopyPlugin());
  pluginSystem.registerPlugin('upload', new UploadPlugin());
  pluginSystem.registerPlugin('favicons', new FaviconPlugin());
  pluginSystem.registerPlugin('loader', new LoaderPlugin());

  // 加载初始数据
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const dataUrl = urlParams.get('data') || 'data/bookmarks.json';
    await pluginSystem.loadBookmarks(dataUrl);
  } catch (error) {
    console.error('Initial load failed:', error);
    alert(`⚠️ 无法加载书签: ${error.message}\n您可以点击'导入书签'手动上传。`);
  }
});
```

## 5\. 实施说明

### 实施步骤

1.  **创建插件系统文件结构**

    ```markdown
    /plugins
      ├── plugin-system.js      # 核心插件系统
      ├── plugin-interface.js   # 基础插件接口
      ├── search-plugin.js      # 搜索功能插件
      ├── copy-plugin.js        # 文本复制插件
      ├── upload-plugin.js      # 文件上传插件
      ├── favicon-plugin.js     # 图标插件
      └── loader-plugin.js      # 加载功能插件
    ```

2.  **修改HTML文件**

    - 更新script标签引用新的主文件
    - 确保所有必要的DOM元素有正确的ID/class

3.  **逐步迁移功能**

    - 首先实现核心系统
    - 然后逐个将现有功能迁移到插件中
    - 测试每个插件独立工作

4.  **测试与验证**

    - 确保所有原有功能正常工作
    - 验证插件可以独立启用/禁用
    - 检查性能影响

### 维护建议

1.  **插件开发规范**

    - 每个插件单独文件
    - 明确的生命周期方法
    - 清晰的依赖声明
    - 完善的错误处理

2.  **版本管理**

    - 插件版本号遵循semver
    - 核心系统与插件版本兼容性检查

3.  **文档要求**

    - 每个插件顶部有使用说明
    - 事件API文档
    - 配置选项说明

### 扩展性设计

1.  **动态加载插件**

    ```markdown
    async function loadExternalPlugin(url) {
      try {
        const module = await import(url);
        if (module && module.default) {
          const plugin = new module.default();
          pluginSystem.registerPlugin(plugin.name, plugin);
        }
      } catch (error) {
        console.error('Failed to load plugin:', error);
      }
    }
    ```

2.  **插件配置界面**

    - 可以添加一个配置管理插件
    - 提供UI界面调整插件设置

3.  **插件间通信**

    - 通过事件系统进行通信
    - 避免直接依赖其他插件

这套实现完整保留了原有所有功能，同时提供了更好的架构和扩展性。您可以根据需要逐步实施，先从核心系统和1-2个简单插件开始，验证架构后再迁移其他功能。

$$$$$$$">
<meta property="og:type" content="article">
<meta property="og:url" content="https://692.cloudns.be/post/cha-jian-jia-zai-qi-wan-zheng-shi-shi-fang-an.html">
<meta property="og:image" content="avatar.svg">
<title>插件加载器完整实施方案</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
html { background: #d2d4d6; }
body{box-sizing: border-box;min-width: 200px;max-width: 960px;margin: 30px auto; padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25; border-radius: 10px; background: rgba(10, 100, 130, 0.08); box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);  overflow: auto;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top: 30px; text-align: center; font-size: small;}
</style>

<style>
.postTitle{margin: auto 0;font-size:1.6em;font-weight:bold;color: #1f85c9;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
.markdown-body h1{font-size: 1.4em;}
.markdown-body h2{font-size: 1.2em;}
.markdown-body h3{font-size: 1em;}
#footer {margin-top: 30px; text-align: center; font-size: small;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 580px) {
     body {margin:0;padding: 12px;box-shadow: none;}
    .postTitle{font-size:1.4em; color: #1f85c9;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>




<body>
    <div id="header">
<h1 class="postTitle">插件加载器完整实施方案</h1>
<div class="title-right">
    <a href="https://692.cloudns.be" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/fjvi/note/issues/36" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><h2>插件加载器完整实施方案</h2>
<p>下面我将提供完整的代码实现方案，包括核心系统、插件接口和现有功能的插件化改造。</p>
<h2>1. 核心系统实现</h2>
<p>创建 <code class="notranslate">plugin-system.js</code> 文件：</p>
<div class="highlight highlight-text-md"><pre class="notranslate">class EventEmitter {
  constructor() {
    this.listeners = new Map();
  }

  on(event, callback) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, <span class="pl-s">[</span><span class="pl-s">]</span>);
    }
    this.listeners.get(event).push(callback);
  }

  emit(event, ...args) {
    if (this.listeners.has(event)) {
      this.listeners.get(event).forEach(callback =&gt; {
        try {
          callback(...args);
        } catch (error) {
          console.error(<span class="pl-s">`</span><span class="pl-c1">Error in ${event} handler:</span><span class="pl-s">`</span>, error);
        }
      });
    }
  }

  off(event, callback) {
    if (this.listeners.has(event)) {
      const callbacks = this.listeners.get(event);
      const index = callbacks.indexOf(callback);
      if (index &gt; -1) {
        callbacks.splice(index, 1);
      }
    }
  }
}

class PluginSystem {
  constructor() {
    this.plugins = new Map();
    this.events = new EventEmitter();
    this.coreElements = {};
    this.coreFunctions = {};
  }

  initializeCore() {
    // 初始化核心元素引用
    this.coreElements = {
      bookmarkTree: document.getElementById("bookmarkTree"),
      searchBox: document.querySelector(".search-box"),
      searchIcon: document.querySelector(".search-icon"),
      importBtn: document.getElementById("import-btn"),
      exportBtn: document.getElementById("export-btn"),
      loadBtn: document.getElementById("load-btn"),
      topBar: document.querySelector(".top-bar"),
      titleText: document.querySelector(".top-bar-title span"),
      topBarTitle: document.querySelector(".top-bar-title"),
      importModal: document.getElementById("import-modal"),
      modalBookmarkFile: document.getElementById("modal-bookmark-file"),
      modalUploadBtn: document.getElementById("modal-upload-btn")
    };

    <span class="pl-c1">// 核心功能</span>
    <span class="pl-c1">this.coreFunctions = {</span>
    <span class="pl-c1">  loadBookmarks: this.loadBookmarks.bind(this),</span>
    <span class="pl-c1">  bindFolderClickEvents: this.bindFolderClickEvents.bind(this),</span>
    <span class="pl-c1">  createBookmarkList: this.createBookmarkList.bind(this),</span>
    <span class="pl-c1">  flattenNodes: this.flattenNodes.bind(this)</span>
    <span class="pl-c1">};</span>
  }

  registerPlugin(name, plugin) {
    if (this.plugins.has(name)) {
      console.warn(<span class="pl-s">`</span><span class="pl-c1">Plugin ${name} already registered</span><span class="pl-s">`</span>);
      return false;
    }

    <span class="pl-c1">try {</span>
    <span class="pl-c1">  plugin.initialize({</span>
    <span class="pl-c1">    elements: this.coreElements,</span>
    <span class="pl-c1">    functions: this.coreFunctions,</span>
    <span class="pl-c1">    events: this.events</span>
    <span class="pl-c1">  });</span>
    <span class="pl-c1">  this.plugins.set(name, plugin);</span>
    <span class="pl-c1">  console.log(`Plugin ${name} registered successfully`);</span>
    <span class="pl-c1">  return true;</span>
    <span class="pl-c1">} catch (error) {</span>
    <span class="pl-c1">  console.error(`Failed to initialize plugin ${name}:`, error);</span>
    <span class="pl-c1">  return false;</span>
    <span class="pl-c1">}</span>
  }

  unregisterPlugin(name) {
    if (this.plugins.has(name)) {
      try {
        this.plugins.get(name).destroy();
        this.plugins.delete(name);
        return true;
      } catch (error) {
        console.error(<span class="pl-s">`</span><span class="pl-c1">Failed to destroy plugin ${name}:</span><span class="pl-s">`</span>, error);
        return false;
      }
    }
    return false;
  }

  getPlugin(name) {
    return this.plugins.get(name);
  }

  // 核心功能实现
  async loadBookmarks(url) {
    // 原有loadBookmarks实现...
  }

  bindFolderClickEvents(calledFrom) {
    // 原有bindFolderClickEvents实现...
  }

  createBookmarkList(node, level) {
    // 原有createBookmarkList实现...
  }

  flattenNodes(nodes, level) {
    // 原有flattenNodes实现...
  }
}

// 导出单例实例
export const pluginSystem = new PluginSystem();</pre></div>
<h2>2. 插件接口实现</h2>
<p>创建 <code class="notranslate">plugin-interface.js</code> 文件：</p>
<div class="highlight highlight-text-md"><pre class="notranslate">export class BasePlugin {
  constructor() {
    if (new.target === BasePlugin) {
      throw new Error("BasePlugin cannot be instantiated directly");
    }
    this.name = "UnnamedPlugin";
    this.version = "1.0.0";
    this.dependencies = <span class="pl-s">[</span><span class="pl-s">]</span>;
  }

  initialize({elements, functions, events}) {
    throw new Error("Plugin must implement initialize method");
  }

  destroy() {
    throw new Error("Plugin must implement destroy method");
  }

  log(message, level = "info") {
    const prefix = <span class="pl-s">`</span><span class="pl-c1">[${this.name}]</span><span class="pl-s">`</span>;
    switch (level) {
      case "error":
        console.error(prefix, message);
        break;
      case "warn":
        console.warn(prefix, message);
        break;
      default:
        console.log(prefix, message);
    }
  }
}</pre></div>
<h2>3. 现有功能插件化改造</h2>
<h3>搜索插件 (search-plugin.js)</h3>
<div class="highlight highlight-text-md"><pre class="notranslate">import { BasePlugin } from './plugin-interface.js';

export class SearchPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = "SearchPlugin";
    this.version = "1.0.0";
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;
    this.functions = functions;

    <span class="pl-c1">this.setupSearch();</span>
    <span class="pl-c1">this.bindEvents();</span>

    <span class="pl-c1">this.log("Initialized successfully");</span>
  }

  setupSearch() {
    this.searchResults = document.createElement("ul");
    this.searchResults.classList.add("search-results");
  }

  bindEvents() {
    // 搜索图标点击事件
    this.elements.searchIcon.addEventListener("click", () =&gt; {
      this.elements.searchIcon.style.display = "none";
      this.elements.searchBox.style.display = "block";
      this.elements.topBar.classList.add("searching");
      this.elements.searchBox.focus();

    <span class="pl-c1">  if (window.innerWidth &lt;= 480) {</span>
    <span class="pl-c1">    this.elements.titleText.style.display = "none";</span>
    <span class="pl-c1">  }</span>
    <span class="pl-c1">});</span>

    <span class="pl-c1">// 搜索框失去焦点事件</span>
    <span class="pl-c1">this.elements.searchBox.addEventListener("blur", () =&gt; {</span>
    <span class="pl-c1">  if (!this.elements.searchBox.value) {</span>
    <span class="pl-c1">    this.elements.searchBox.style.display = "none";</span>
    <span class="pl-c1">    this.elements.searchIcon.style.display = "block";</span>
    <span class="pl-c1">    this.elements.topBar.classList.remove("searching");</span>

    <span class="pl-c1">    if (window.innerWidth &lt;= 480) {</span>
    <span class="pl-c1">      this.elements.titleText.style.display = "inline";</span>
    <span class="pl-c1">    }</span>
    <span class="pl-c1">  }</span>
    <span class="pl-c1">});</span>

    <span class="pl-c1">// 搜索输入事件</span>
    <span class="pl-c1">this.elements.searchBox.addEventListener("input", () =&gt; {</span>
    <span class="pl-c1">  this.handleSearchInput();</span>
    <span class="pl-c1">});</span>

    <span class="pl-c1">// 标题点击事件 - 清除搜索</span>
    <span class="pl-c1">this.elements.topBarTitle.addEventListener("click", () =&gt; {</span>
    <span class="pl-c1">  this.elements.searchBox.value = "";</span>
    <span class="pl-c1">  this.elements.searchBox.style.display = "none";</span>
    <span class="pl-c1">  this.elements.searchIcon.style.display = "block";</span>
    <span class="pl-c1">  this.elements.topBar.classList.remove("searching");</span>
    <span class="pl-c1">  this.elements.titleText.style.display = window.innerWidth &lt;= 480 ? "inline" : "inline";</span>
    <span class="pl-c1">  this.events.emit("search-cleared");</span>
    <span class="pl-c1">});</span>
  }

  handleSearchInput() {
    const keyword = this.elements.searchBox.value.trim().toLowerCase();
    this.elements.bookmarkTree.innerHTML = "";

    <span class="pl-c1">if (keyword) {</span>
    <span class="pl-c1">  const regex = new RegExp(keyword, "gi");</span>
    <span class="pl-c1">  const results = this.functions.flattenNodes(this.currentData || [], 2)</span>
    <span class="pl-c1">    .filter(node =&gt;</span>
    <span class="pl-c1">      node.title.toLowerCase().includes(keyword) ||</span>
    <span class="pl-c1">      (node.url &amp;&amp; node.url.toLowerCase().includes(keyword))</span>
    <span class="pl-c1">    );</span>

    <span class="pl-c1">  this.displaySearchResults(results, regex);</span>
    <span class="pl-c1">} else {</span>
    <span class="pl-c1">  this.events.emit("search-cleared");</span>
    <span class="pl-c1">}</span>
  }

  displaySearchResults(results, regex) {
    this.searchResults.innerHTML = "";

    <span class="pl-c1">results.forEach(result =&gt; {</span>
    <span class="pl-c1">  const li = document.createElement("li");</span>
    <span class="pl-c1">  const a = document.createElement("a");</span>
    <span class="pl-c1">  a.href = result.url || result.originalNode.url;</span>
    <span class="pl-c1">  a.classList.add("bookmark-link");</span>
    <span class="pl-c1">  a.target = "_blank";</span>

    <span class="pl-c1">  const highlightedTitle = result.title.replace(regex, `&lt;mark&gt;{{markdown}}&lt;/mark&gt;`);</span>
    <span class="pl-c1">  a.innerHTML = highlightedTitle;</span>

    <span class="pl-c1">  const icon = document.createElement("img");</span>
    <span class="pl-c1">  icon.src = "https://www.google.com/s2/favicons?sz=32&amp;domain_url=" +</span>
    <span class="pl-c1">            encodeURIComponent(result.url || result.originalNode.url);</span>
    <span class="pl-c1">  icon.classList.add("favicon-icon");</span>
    <span class="pl-c1">  a.prepend(icon);</span>

    <span class="pl-c1">  li.appendChild(a);</span>
    <span class="pl-c1">  this.searchResults.appendChild(li);</span>
    <span class="pl-c1">});</span>

    <span class="pl-c1">this.elements.bookmarkTree.appendChild(this.searchResults);</span>
  }

  destroy() {
    // 清理事件监听器
    this.elements.searchIcon.removeEventListener("click");
    this.elements.searchBox.removeEventListener("blur");
    this.elements.searchBox.removeEventListener("input");
    this.elements.topBarTitle.removeEventListener("click");

    <span class="pl-c1">this.log("Destroyed successfully");</span>
  }
}</pre></div>
<h3>文本复制插件 (copy-plugin.js)</h3>
<div class="highlight highlight-text-md"><pre class="notranslate">import { BasePlugin } from './plugin-interface.js';

export class CopyPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = "CopyPlugin";
    this.version = "1.0.0";
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    <span class="pl-c1">this.setupCopyHandlers();</span>
    <span class="pl-c1">events.on('bookmark-rendered', this.updateCopyHandlers.bind(this));</span>

    <span class="pl-c1">this.log("Initialized successfully");</span>
  }

  setupCopyHandlers() {
    document.addEventListener('click', (e) =&gt; {
      if (e.target.closest('.bookmark-data-item')) {
        this.handleCopyClick(e);
      }
    });
  }

  updateCopyHandlers() {
    const dataItems = document.querySelectorAll('.bookmark-data-item');
    dataItems.forEach(item =&gt; {
      item.addEventListener('click', this.handleCopyClick.bind(this));
    });
  }

  handleCopyClick(e) {
    e.preventDefault();
    e.stopPropagation();

    <span class="pl-c1">const wrapper = e.target.closest('.bookmark-data-item');</span>
    <span class="pl-c1">if (!wrapper) return;</span>

    <span class="pl-c1">const copyIcon = wrapper.querySelector('.copy-symbol');</span>
    <span class="pl-c1">const text = wrapper.querySelector('.copyable');</span>
    <span class="pl-c1">const node = this.findNodeByTitle(text.textContent);</span>

    <span class="pl-c1">if (!node || !node.url) return;</span>

    <span class="pl-c1">try {</span>
    <span class="pl-c1">  const html = decodeURIComponent(node.url.split(",")[1]);</span>
    <span class="pl-c1">  const match = html.match(/&lt;pre&gt;([\s\S]*?)&lt;\/pre&gt;/i);</span>
    <span class="pl-c1">  if (match) {</span>
    <span class="pl-c1">    const content = match[1]</span>
    <span class="pl-c1">      .replace(/&amp;lt;/g, "&lt;")</span>
    <span class="pl-c1">      .replace(/&amp;gt;/g, "&gt;")</span>
    <span class="pl-c1">      .replace(/&amp;amp;/g, "&amp;");</span>

    <span class="pl-c1">    navigator.clipboard.writeText(content).then(() =&gt; {</span>
    <span class="pl-c1">      copyIcon.textContent = "✅";</span>
    <span class="pl-c1">      wrapper.classList.add("copied");</span>
    <span class="pl-c1">      setTimeout(() =&gt; {</span>
    <span class="pl-c1">        copyIcon.textContent = "📋";</span>
    <span class="pl-c1">        wrapper.classList.remove("copied");</span>
    <span class="pl-c1">      }, 2000);</span>
    <span class="pl-c1">    });</span>
    <span class="pl-c1">  }</span>
    <span class="pl-c1">} catch (error) {</span>
    <span class="pl-c1">  this.log(`Copy failed: ${error.message}`, 'error');</span>
    <span class="pl-c1">}</span>
  }

  findNodeByTitle(title) {
    // 在实际应用中，这里应该搜索当前显示的书签数据
    return null;
  }

  destroy() {
    document.removeEventListener('click', this.handleCopyClick);
    this.events.off('bookmark-rendered', this.updateCopyHandlers);
    this.log("Destroyed successfully");
  }
}</pre></div>
<h3>文件上传插件 (upload-plugin.js)</h3>
<div class="highlight highlight-text-md"><pre class="notranslate">import { BasePlugin } from './plugin-interface.js';

export class UploadPlugin extends BasePlugin {
  constructor() {
    super();
    this.name = "UploadPlugin";
    this.version = "1.0.0";
  }

  initialize({elements, functions, events}) {
    this.elements = elements;
    this.events = events;

    <span class="pl-c1">this.setupUpload();</span>
    <span class="pl-c1">events.on('data-loaded', this.handleNewData.bind(this));</span>

    <span class="pl-c1">this.log("Initialized successfully");</span>
  }

  setupUpload() {
    // 文件选择变化事件
    this.elements.modalBookmarkFile.addEventListener("change", () =&gt; {
      this.handleFileSelect();
    });

    <span class="pl-c1">// 上传按钮点击事件</span>
    <span class="pl-c1">this.elements.modalUploadBtn.addEventListener("click", async () =&gt; {</span>
    <span class="pl-c1">  await this.handleUpload();</span>
    <span class="pl-c1">});</span>
  }

  handleFileSelect() {
    const file = this.elements.modalBookmarkFile.files<span class="pl-s">[</span>0<span class="pl-s">]</span>;
    if (!file) return;

    <span class="pl-c1">const reader = new FileReader();</span>
    <span class="pl-c1">reader.onload = e =&gt; {</span>
    <span class="pl-c1">  this.events.emit('file-selected', e.target.result);</span>
    <span class="pl-c1">};</span>
    <span class="pl-c1">reader.readAsText(file);</span>
  }

  async handleUpload() {
    const token = prompt("请输入 GitHub Token：");
    if (!token) {
      alert("❌ 未提供 Token，上传已取消");
      return;
    }

    <span class="pl-c1">try {</span>
    <span class="pl-c1">  const repo = "fjvi/bookmark";</span>
    <span class="pl-c1">  const path = "data/bookmarks.json";</span>
    <span class="pl-c1">  const branch = "main";</span>
    <span class="pl-c1">  const getURL = `https://api.github.com/repos/${repo}/contents/${path}`;</span>
    <span class="pl-c1">  let sha = null;</span>

    <span class="pl-c1">  // 获取现有文件的SHA（如果存在）</span>
    <span class="pl-c1">  const res = await fetch(getURL, {</span>
    <span class="pl-c1">    headers: { Authorization: "token " + token }</span>
    <span class="pl-c1">  });</span>

    <span class="pl-c1">  if (res.ok) {</span>
    <span class="pl-c1">    const json = await res.json();</span>
    <span class="pl-c1">    sha = json.sha;</span>
    <span class="pl-c1">  }</span>

    <span class="pl-c1">  // 准备上传内容</span>
    <span class="pl-c1">  const content = btoa(unescape(encodeURIComponent(this.currentData)));</span>
    <span class="pl-c1">  const payload = {</span>
    <span class="pl-c1">    message: "更新书签 JSON",</span>
    <span class="pl-c1">    content,</span>
    <span class="pl-c1">    branch,</span>
    <span class="pl-c1">    ...(sha &amp;&amp; { sha })</span>
    <span class="pl-c1">  };</span>

    <span class="pl-c1">  // 执行上传</span>
    <span class="pl-c1">  const uploadRes = await fetch(getURL, {</span>
    <span class="pl-c1">    method: "PUT",</span>
    <span class="pl-c1">    headers: {</span>
    <span class="pl-c1">      Authorization: "token " + token,</span>
    <span class="pl-c1">      "Content-Type": "application/json"</span>
    <span class="pl-c1">    },</span>
    <span class="pl-c1">    body: JSON.stringify(payload)</span>
    <span class="pl-c1">  });</span>

    <span class="pl-c1">  if (uploadRes.ok) {</span>
    <span class="pl-c1">    alert("✅ 上传成功！");</span>
    <span class="pl-c1">    this.events.emit('upload-success');</span>
    <span class="pl-c1">  } else {</span>
    <span class="pl-c1">    throw new Error("上传失败");</span>
    <span class="pl-c1">  }</span>
    <span class="pl-c1">} catch (error) {</span>
    <span class="pl-c1">  this.log(`Upload failed: ${error.message}`, 'error');</span>
    <span class="pl-c1">  alert("❌ 上传失败");</span>
    <span class="pl-c1">}</span>
  }

  handleNewData(data) {
    this.currentData = JSON.stringify(data, null, 2);
  }

  destroy() {
    this.elements.modalBookmarkFile.removeEventListener("change", this.handleFileSelect);
    this.elements.modalUploadBtn.removeEventListener("click", this.handleUpload);
    this.events.off('data-loaded', this.handleNewData);
    this.log("Destroyed successfully");
  }
}</pre></div>
<h2>4. 主应用改造 (main.js)</h2>
<div class="highlight highlight-text-md"><pre class="notranslate">import { pluginSystem } from './plugin-system.js';
import { SearchPlugin } from './search-plugin.js';
import { CopyPlugin } from './copy-plugin.js';
import { UploadPlugin } from './upload-plugin.js';
import { FaviconPlugin } from './favicon-plugin.js';
import { LoaderPlugin } from './loader-plugin.js';

// 初始化插件系统
document.addEventListener('DOMContentLoaded', async () =&gt; {
  // 初始化核心系统
  pluginSystem.initializeCore();

  // 注册插件
  pluginSystem.registerPlugin('search', new SearchPlugin());
  pluginSystem.registerPlugin('copy', new CopyPlugin());
  pluginSystem.registerPlugin('upload', new UploadPlugin());
  pluginSystem.registerPlugin('favicons', new FaviconPlugin());
  pluginSystem.registerPlugin('loader', new LoaderPlugin());

  // 加载初始数据
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const dataUrl = urlParams.get('data') || "data/bookmarks.json";
    await pluginSystem.loadBookmarks(dataUrl);
  } catch (error) {
    console.error("Initial load failed:", error);
    alert(<span class="pl-s">`</span><span class="pl-c1">⚠️ 无法加载书签: ${error.message}\n您可以点击"导入书签"手动上传。</span><span class="pl-s">`</span>);
  }
});</pre></div>
<h2>5. 实施说明</h2>
<h3>实施步骤</h3>
<ol>
<li>
<p><strong>创建插件系统文件结构</strong></p>
<div class="highlight highlight-text-md"><pre class="notranslate">/plugins
  ├── plugin-system.js      # 核心插件系统
  ├── plugin-interface.js   # 基础插件接口
  ├── search-plugin.js      # 搜索功能插件
  ├── copy-plugin.js        # 文本复制插件
  ├── upload-plugin.js      # 文件上传插件
  ├── favicon-plugin.js     # 图标插件
  └── loader-plugin.js      # 加载功能插件</pre></div>
</li>
<li>
<p><strong>修改HTML文件</strong></p>
<ul>
<li>更新script标签引用新的主文件</li>
<li>确保所有必要的DOM元素有正确的ID/class</li>
</ul>
</li>
<li>
<p><strong>逐步迁移功能</strong></p>
<ul>
<li>首先实现核心系统</li>
<li>然后逐个将现有功能迁移到插件中</li>
<li>测试每个插件独立工作</li>
</ul>
</li>
<li>
<p><strong>测试与验证</strong></p>
<ul>
<li>确保所有原有功能正常工作</li>
<li>验证插件可以独立启用/禁用</li>
<li>检查性能影响</li>
</ul>
</li>
</ol>
<h3>维护建议</h3>
<ol>
<li>
<p><strong>插件开发规范</strong></p>
<ul>
<li>每个插件单独文件</li>
<li>明确的生命周期方法</li>
<li>清晰的依赖声明</li>
<li>完善的错误处理</li>
</ul>
</li>
<li>
<p><strong>版本管理</strong></p>
<ul>
<li>插件版本号遵循semver</li>
<li>核心系统与插件版本兼容性检查</li>
</ul>
</li>
<li>
<p><strong>文档要求</strong></p>
<ul>
<li>每个插件顶部有使用说明</li>
<li>事件API文档</li>
<li>配置选项说明</li>
</ul>
</li>
</ol>
<h3>扩展性设计</h3>
<ol>
<li>
<p><strong>动态加载插件</strong></p>
<div class="highlight highlight-text-md"><pre class="notranslate">async function loadExternalPlugin(url) {
  try {
    const module = await import(url);
    if (module &amp;&amp; module.default) {
      const plugin = new module.default();
      pluginSystem.registerPlugin(plugin.name, plugin);
    }
  } catch (error) {
    console.error('Failed to load plugin:', error);
  }
}</pre></div>
</li>
<li>
<p><strong>插件配置界面</strong></p>
<ul>
<li>可以添加一个配置管理插件</li>
<li>提供UI界面调整插件设置</li>
</ul>
</li>
<li>
<p><strong>插件间通信</strong></p>
<ul>
<li>通过事件系统进行通信</li>
<li>避免直接依赖其他插件</li>
</ul>
</li>
</ol>
<p>这套实现完整保留了原有所有功能，同时提供了更好的架构和扩展性。您可以根据需要逐步实施，先从核心系统和1-2个简单插件开始，验证架构后再迁移其他功能。</p></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://692.cloudns.be">MGTime</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>
<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if("01/01/2025"!=""){
    var startSite=new Date("01/01/2025");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行"+diffDay+"天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.disabled=true;
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","fjvi/note");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>
<script src='../assets/ArticleTOC.js'></script><script src='../assets/backtop.js'></script><script src='../assets/lightbox.js'></script><script src='../assets/imgca.js'></script>

</html>